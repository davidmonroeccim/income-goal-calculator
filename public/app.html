<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Income Goal Calculator</title>
    <meta name="description" content="Your CRE income tracking dashboard">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css?v=1.1">
    <link rel="stylesheet" href="/css/app.css?v=1.1">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <a href="/app" class="logo-link">
                        <img src="/images/logo.png" alt="AcquisitionPRO Logo" class="logo">
                    </a>
                    <nav class="app-nav">
                        <a href="/app" class="nav-link active">Dashboard</a>
                        <a href="/calculator" class="nav-link">Calculator</a>
                        <a href="/activities" class="nav-link">Activity Tracker</a>
                        <a href="/profile" class="nav-link">Profile</a>
                    </nav>
                    <div class="user-menu">
                        <span class="user-greeting" id="userGreeting">Loading...</span>
                        <button class="btn btn-secondary btn-sm" id="logoutButton">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" style="min-height: calc(100vh - 200px); padding-top: var(--spacing-lg);">
            <div class="container" style="max-width: 1200px;">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <h1>Dashboard</h1>
                    <p>Welcome to your CRE Income Goal Calculator</p>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="action-card">
                        <div class="action-icon">üßÆ</div>
                        <h3>Goal Calculator</h3>
                        <p>Calculate your required daily activities to reach your CRE income goals</p>
                        <a href="/calculator" class="btn btn-primary">Open Calculator</a>
                    </div>

                    <div class="action-card">
                        <div class="action-icon">üìä</div>
                        <h3>Activity Tracking</h3>
                        <p>Track your daily activities and monitor your progress (Premium Feature)</p>
                        <a href="/activities" class="btn btn-secondary">Start Tracking</a>
                    </div>

                    <div class="action-card">
                        <div class="action-icon">üë§</div>
                        <h3>Profile Settings</h3>
                        <p>Manage your account settings and preferences</p>
                        <a href="/profile" class="btn btn-secondary">View Profile</a>
                    </div>
                </div>

                <!-- Recent Activity / Goals Summary -->
                <div class="dashboard-content">
                    <div class="content-section">
                        <div class="section-header">
                            <h2>Your Goals Summary</h2>
                            <p id="goalsStatus">No goals calculated yet. <a href="/calculator">Start calculating</a></p>
                        </div>

                        <!-- Broker Goals -->
                        <div id="brokerGoalsSummary" class="goals-summary" style="display: none; margin-bottom: var(--spacing-lg);">
                            <h3 style="color: var(--secondary-blue); margin-bottom: var(--spacing-md);">üè† Broker Goals</h3>
                            <div class="goal-item">
                                <span class="goal-label">Net Commission Goal</span>
                                <span class="goal-value" id="brokerNetCommissionGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Gross Commission Goal</span>
                                <span class="goal-value" id="brokerGrossCommissionGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Daily Attempts Needed</span>
                                <span class="goal-value" id="brokerDailyAttemptsGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Total Closings Needed</span>
                                <span class="goal-value" id="brokerClosingsNeededGoal">-</span>
                            </div>
                        </div>

                        <!-- Investor Goals -->
                        <div id="investorGoalsSummary" class="goals-summary" style="display: none;">
                            <h3 style="color: var(--accent-yellow); margin-bottom: var(--spacing-md);">üí∞ Investor Goals</h3>
                            <div class="goal-item">
                                <span class="goal-label">Net Acquisition Fee Goal</span>
                                <span class="goal-value" id="investorNetAcquisitionFeeGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Gross Acquisition Fee Goal</span>
                                <span class="goal-value" id="investorGrossAcquisitionFeeGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Daily Attempts Needed</span>
                                <span class="goal-value" id="investorDailyAttemptsGoal">-</span>
                            </div>
                            <div class="goal-item">
                                <span class="goal-label">Total Closings Needed</span>
                                <span class="goal-value" id="investorClosingsNeededGoal">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="content-section">
                        <div class="section-header">
                            <h2>Getting Started</h2>
                            <p>Follow these steps to maximize your success</p>
                        </div>
                        
                        <div class="getting-started-steps">
                            <div class="step-item">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Calculate Your Goals</h4>
                                    <p>Use our calculator to determine your required daily activities</p>
                                </div>
                            </div>
                            
                            <div class="step-item">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Track Your Progress</h4>
                                    <p>Monitor your daily activities to stay on track (Premium Feature)</p>
                                </div>
                            </div>
                            
                            <div class="step-item">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Achieve Your Goals</h4>
                                    <p>Stay consistent and watch your CRE income grow</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-logo-section">
                        <img src="/images/logo.png" alt="AcquisitionPRO Logo" class="footer-logo">
                        <p>&copy; 2024 AcquisitionPRO. All rights reserved.</p>
                    </div>
                    <div class="footer-links">
                        <a href="/privacy">Privacy Policy</a>
                        <a href="/terms">Terms of Service</a>
                        <a href="/contact">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>

        // Global variables
        let currentUser = null;
        let accessToken = null;

        // DOM Elements
        const userGreeting = document.getElementById('userGreeting');
        const logoutButton = document.getElementById('logoutButton');

        // Initialize page
        window.addEventListener('DOMContentLoaded', async function() {
            await initializeAuth();
            setupEventListeners();
            await loadUserGoals();
        });

        // Authentication initialization
        async function initializeAuth() {
            // Wait for auth manager to be available
            if (!window.authManager) {
                setTimeout(initializeAuth, 100);
                return;
            }

            // Check authentication using auth manager
            if (!window.authManager.isAuthenticated()) {
                redirectToLogin();
                return;
            }

            accessToken = window.authManager.getAccessToken();

            try {
                currentUser = await window.authManager.getCurrentUser();
                
                // Update user greeting
                if (currentUser && currentUser.profile) {
                    userGreeting.textContent = `Hello, ${currentUser.profile.first_name}!`;
                } else {
                    userGreeting.textContent = 'Hello!';
                }

            } catch (error) {
                console.error('Auth initialization error:', error);
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            if (window.authManager) {
                window.authManager.clearTokens();
            } else {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_profile');
            }
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout button
            logoutButton.addEventListener('click', handleLogout);
        }

        // Logout handler
        async function handleLogout() {
            if (window.authManager) {
                await window.authManager.handleLogout();
            } else {
                // Fallback if auth manager not available
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Load user goals - Load both broker and investor goals
        async function loadUserGoals() {
            if (!currentUser || !window.authManager) return;

            let hasAnyGoals = false;

            try {
                // Load broker goals
                let response = await window.authManager.makeAuthenticatedRequest('/api/goals/load?type=broker');

                if (response.ok) {
                    const result = await response.json();
                    console.log('Broker goals result:', result);

                    if (result.goals && result.goals.goal_data) {
                        displayBrokerGoals(result.goals.goal_data);
                        hasAnyGoals = true;
                    }
                }

                // Load investor goals
                response = await window.authManager.makeAuthenticatedRequest('/api/goals/load?type=investor');

                if (response.ok) {
                    const result = await response.json();
                    console.log('Investor goals result:', result);

                    if (result.goals && result.goals.goal_data) {
                        displayInvestorGoals(result.goals.goal_data);
                        hasAnyGoals = true;
                    }
                }

                // Hide status message if we have any goals
                if (hasAnyGoals) {
                    document.getElementById('goalsStatus').style.display = 'none';
                } else {
                    console.log('No goals found for user');
                }

            } catch (error) {
                console.error('Load goals error:', error);
            }
        }

        // Display broker goals
        function displayBrokerGoals(goalData) {
            const brokerGoalsSummary = document.getElementById('brokerGoalsSummary');

            if (goalData && goalData.netCommission) {
                brokerGoalsSummary.style.display = 'block';

                // Update values for broker
                document.getElementById('brokerNetCommissionGoal').textContent = '$' + goalData.netCommission.toLocaleString('en-US');
                document.getElementById('brokerGrossCommissionGoal').textContent = '$' + goalData.grossCommission.toLocaleString('en-US');
                document.getElementById('brokerDailyAttemptsGoal').textContent = goalData.dailyAttempts;
                document.getElementById('brokerClosingsNeededGoal').textContent = goalData.closingsNeeded;

                console.log('Broker goals displayed');
            }
        }

        // Display investor goals
        function displayInvestorGoals(goalData) {
            const investorGoalsSummary = document.getElementById('investorGoalsSummary');

            if (goalData && goalData.netAcquisitionFee) {
                investorGoalsSummary.style.display = 'block';

                // Update values for investor
                document.getElementById('investorNetAcquisitionFeeGoal').textContent = '$' + goalData.netAcquisitionFee.toLocaleString('en-US');
                document.getElementById('investorGrossAcquisitionFeeGoal').textContent = '$' + goalData.grossAcquisitionFee.toLocaleString('en-US');
                document.getElementById('investorDailyAttemptsGoal').textContent = goalData.dailyAttempts;
                document.getElementById('investorClosingsNeededGoal').textContent = goalData.closingsNeeded;

                console.log('Investor goals displayed');
            }
        }

        // Show coming soon alert
        function showComingSoon() {
            alert('Activity tracking is coming soon! This will be a premium feature that allows you to track your daily progress and monitor your performance against your goals.');
        }
    </script>

    <!-- Auth Management -->
    <script src="/js/auth.js"></script>
    
    <!-- Iframe Detection -->
    <script src="/js/iframe-detector.js"></script>
</body>
</html>