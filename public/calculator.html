<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Goal Calculator</title>
    <meta name="description" content="Calculate your CRE income goals and track your progress">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css?v=1.1">
    <link rel="stylesheet" href="/css/app.css?v=1.1">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <div class="header-content">
                    <a href="/app" class="logo-link">
                        <img src="/images/logo.png" alt="AcquisitionPRO Logo" class="logo">
                    </a>
                    <nav class="app-nav">
                        <a href="/app" class="nav-link">Dashboard</a>
                        <a href="/calculator" class="nav-link active">Calculator</a>
                        <a href="/activities" class="nav-link">Activity Tracker</a>
                        <a href="/profile" class="nav-link">Profile</a>
                    </nav>
                    <div class="user-menu">
                        <span class="user-greeting" id="userGreeting">Loading...</span>
                        <button class="btn btn-secondary btn-sm" id="logoutButton">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" style="min-height: calc(100vh - 200px); padding-top: var(--spacing-lg);">
            <div class="container" style="max-width: 1400px;">
                <!-- Calculator Container -->
                <div class="calculator-container">
                    <!-- Header -->
                    <div class="calculator-header">
                        <h1>Income Goal Calculator</h1>
                        <p>Calculate your required daily activities to reach your CRE income goals</p>
                    </div>

                    <!-- User Type Toggle -->
                    <div class="user-type-toggle" id="userTypeToggle">
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" data-type="broker" id="brokerToggle">
                                üè† Broker Calculator
                            </button>
                            <button class="toggle-btn" data-type="investor" id="investorToggle">
                                üí∞ Investor Calculator
                            </button>
                        </div>
                    </div>

                    <!-- Broker Calculator -->
                    <div class="calculator-content" id="brokerCalculator">
                        <div class="calculator-grid">
                            <!-- Input Panel -->
                            <div class="input-panel">
                                <div class="panel-title">Input Your Goals & Ratios</div>
                                
                                <div class="form-section">
                                    <div class="section-title">Commission Goals</div>
                                    <div class="form-group">
                                        <label for="netCommission">Net Commission Goal ($)</label>
                                        <input type="number" id="netCommission" value="250000" step="1000" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="commissionSplit">Company Commission Split (%)</label>
                                        <input type="number" id="commissionSplit" value="50" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="avgSalePrice">Average Sale Price ($)</label>
                                        <input type="number" id="avgSalePrice" value="3000000" step="10000" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="avgCommission">Average Sales Commission (%)</label>
                                        <input type="number" id="avgCommission" value="3" step="0.1" min="0" max="100">
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="section-title">Performance Ratios</div>
                                    <div class="form-group">
                                        <label for="closingRatio">Contract to Closing Ratio (%)</label>
                                        <input type="number" id="closingRatio" value="75" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="appointmentRatio">1st Appointment to Contract Ratio (%)</label>
                                        <input type="number" id="appointmentRatio" value="10" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="contactRatio">Contact to 1st Appointment Ratio (%)</label>
                                        <input type="number" id="contactRatio" value="10" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="attemptRatio">Attempts to Contact Ratio (%)</label>
                                        <input type="number" id="attemptRatio" value="20" step="1" min="0" max="100">
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="section-title">Time Planning</div>
                                    <div class="form-group">
                                        <label for="vacationDays">Vacation Days Planned</label>
                                        <input type="number" id="vacationDays" value="5" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="sickDays">Sick Days Projected</label>
                                        <input type="number" id="sickDays" value="5" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="conferenceDays">Conference Days Planned</label>
                                        <input type="number" id="conferenceDays" value="20" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="trainingDays">Training Days Planned</label>
                                        <input type="number" id="trainingDays" value="20" step="1" min="0">
                                    </div>
                                </div>

                                <div class="calculator-actions">
                                    <button class="btn btn-primary" id="calculateButton">Calculate Your Numbers</button>
                                    <button class="btn btn-secondary" id="saveGoalsButton">Save Goals</button>
                                </div>
                            </div>

                            <!-- Results Panel -->
                            <div class="results-panel">
                                <div class="panel-title">Your Required Numbers</div>
                                
                                <div class="result-item highlight-result">
                                    <div class="result-label">Gross Commission Goal</div>
                                    <div class="result-value" id="grossCommission">$500,000</div>
                                </div>

                                <div class="result-item highlight-result">
                                    <div class="result-label">Total Weeks Worked in Year</div>
                                    <div class="result-value" id="weeksWorked">42</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Closings Needed</div>
                                    <div class="result-value" id="closingsNeeded">6</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Contracts Needed</div>
                                    <div class="result-value" id="contractsNeeded">8</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total 1st Appointments Needed</div>
                                    <div class="result-value" id="appointmentsNeeded">75</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Decision Makers Reached</div>
                                    <div class="result-value" id="decisionMakers">741</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Attempts Needed</div>
                                    <div class="result-value" id="totalAttempts">3,704</div>
                                </div>

                                <div class="result-item highlight-result">
                                    <div class="result-label">Total Daily Attempts Needed</div>
                                    <div class="result-value" id="dailyAttempts">18</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Investor Calculator -->
                    <div class="calculator-content" id="investorCalculator" style="display: none;">
                        <div class="calculator-grid">
                            <!-- Input Panel -->
                            <div class="input-panel">
                                <div class="panel-title">Input Your Goals & Ratios</div>
                                
                                <div class="form-section">
                                    <div class="section-title">Acquisition Fee Goals</div>
                                    <div class="form-group">
                                        <label for="netAcquisitionFee">Net Acquisition Fee Goal ($)</label>
                                        <input type="number" id="netAcquisitionFee" value="250000" step="1000" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="reinvestmentPercentage">Reinvestment Percentage (Must be > 0) (%)</label>
                                        <input type="number" id="reinvestmentPercentage" value="20" step="0.1" min="0.1" max="99">
                                    </div>
                                    <div class="form-group">
                                        <label for="invAvgSalePrice">Average Sale Price ($)</label>
                                        <input type="number" id="invAvgSalePrice" value="3000000" step="10000" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="avgAcquisitionFee">Average Acquisition Fee (%)</label>
                                        <input type="number" id="avgAcquisitionFee" value="3" step="0.1" min="0" max="100">
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="section-title">Performance Ratios</div>
                                    <div class="form-group">
                                        <label for="invClosingRatio">Contract to Closing Ratio (%)</label>
                                        <input type="number" id="invClosingRatio" value="75" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="opportunityRatio">Opportunity Found to Contract Ratio (%)</label>
                                        <input type="number" id="opportunityRatio" value="75" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="invAppointmentRatio">1st Appt W/Owner to Opportunity Ratio (%)</label>
                                        <input type="number" id="invAppointmentRatio" value="10" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="invContactRatio">Contact to 1st Appointment Ratio (%)</label>
                                        <input type="number" id="invContactRatio" value="10" step="1" min="0" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="invAttemptRatio">Attempts to Contact Ratio (%)</label>
                                        <input type="number" id="invAttemptRatio" value="20" step="1" min="0" max="100">
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="section-title">Time Planning</div>
                                    <div class="form-group">
                                        <label for="invVacationDays">Vacation Days Planned</label>
                                        <input type="number" id="invVacationDays" value="10" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="invSickDays">Sick Days Projected</label>
                                        <input type="number" id="invSickDays" value="5" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="invConferenceDays">Conference Days Planned</label>
                                        <input type="number" id="invConferenceDays" value="10" step="1" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="invTrainingDays">Training Days Planned</label>
                                        <input type="number" id="invTrainingDays" value="10" step="1" min="0">
                                    </div>
                                </div>

                                <div class="calculator-actions">
                                    <button class="btn btn-primary" id="calculateInvestorButton">Calculate Your Numbers</button>
                                    <button class="btn btn-secondary" id="saveInvestorGoalsButton">Save Goals</button>
                                </div>
                            </div>

                            <!-- Results Panel -->
                            <div class="results-panel">
                                <div class="panel-title">Your Required Numbers</div>
                                
                                <div class="result-item highlight-result">
                                    <div class="result-label">Gross Acquisition Fee Goal</div>
                                    <div class="result-value" id="grossAcquisitionFee">$312,500</div>
                                </div>

                                <div class="result-item highlight-result">
                                    <div class="result-label">Total Weeks Worked in Year</div>
                                    <div class="result-value" id="invWeeksWorked">45</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Closings Needed</div>
                                    <div class="result-value" id="invClosingsNeeded">3</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Contracts Needed</div>
                                    <div class="result-value" id="invContractsNeeded">5</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Opportunities Needed</div>
                                    <div class="result-value" id="opportunitiesNeeded">6</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total 1st Appointments Needed</div>
                                    <div class="result-value" id="invAppointmentsNeeded">62</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Decision Makers Reached</div>
                                    <div class="result-value" id="invDecisionMakers">617</div>
                                </div>

                                <div class="result-item">
                                    <div class="result-label">Total Attempts Needed</div>
                                    <div class="result-value" id="invTotalAttempts">3,086</div>
                                </div>

                                <div class="result-item highlight-result">
                                    <div class="result-label">Total Daily Attempts Needed</div>
                                    <div class="result-value" id="invDailyAttempts">14</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-logo-section">
                        <img src="/images/logo.png" alt="AcquisitionPRO Logo" class="footer-logo">
                        <p>&copy; 2024 AcquisitionPRO. All rights reserved.</p>
                    </div>
                    <div class="footer-links">
                        <a href="/privacy">Privacy Policy</a>
                        <a href="/terms">Terms of Service</a>
                        <a href="/contact">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let accessToken = null;
        let goals = {};
        let currentCalculatorType = 'broker';

        // DOM Elements
        const userGreeting = document.getElementById('userGreeting');
        const logoutButton = document.getElementById('logoutButton');

        // Initialize page
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, initializing calculator...');
            setupEventListeners();
            
            // Try to initialize auth (but don't require it for calculator to work)
            try {
                await initializeAuth();
                await loadSavedGoals();
            } catch (error) {
                console.log('Auth not available, running calculator in guest mode');
                // Hide auth-related elements
                const userGreeting = document.getElementById('userGreeting');
                const logoutButton = document.getElementById('logoutButton');
                if (userGreeting) userGreeting.textContent = 'Guest User';
                if (logoutButton) logoutButton.style.display = 'none';
            }
            
            // Always calculate numbers on page load
            calculateNumbers();
            console.log('Calculator initialized');
        });

        // Authentication initialization
        async function initializeAuth() {
            // Wait for auth manager to be available
            if (!window.authManager) {
                setTimeout(initializeAuth, 100);
                return;
            }

            // Check authentication using auth manager
            if (!window.authManager.isAuthenticated()) {
                console.log('No authentication found - running in guest mode');
                return;
            }

            accessToken = window.authManager.getAccessToken();

            try {
                currentUser = await window.authManager.getCurrentUser();
                
                // Update user greeting
                if (currentUser && currentUser.profile) {
                    userGreeting.textContent = `Hello, ${currentUser.profile.first_name}!`;
                } else {
                    userGreeting.textContent = 'Hello!';
                }

            } catch (error) {
                console.error('Auth initialization error:', error);
                redirectToLogin();
            }
        }

        function redirectToLogin() {
            if (window.authManager) {
                window.authManager.clearTokens();
            } else {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_profile');
            }
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Logout button
            logoutButton.addEventListener('click', handleLogout);

            // Calculator action buttons
            const calculateButton = document.getElementById('calculateButton');
            const saveGoalsButton = document.getElementById('saveGoalsButton');
            const calculateInvestorButton = document.getElementById('calculateInvestorButton');
            const saveInvestorGoalsButton = document.getElementById('saveInvestorGoalsButton');
            
            if (calculateButton) {
                calculateButton.addEventListener('click', calculateNumbers);
            }
            
            if (saveGoalsButton) {
                saveGoalsButton.addEventListener('click', () => saveGoals());
            }

            if (calculateInvestorButton) {
                calculateInvestorButton.addEventListener('click', calculateInvestorNumbers);
            }
            
            if (saveInvestorGoalsButton) {
                saveInvestorGoalsButton.addEventListener('click', () => saveGoals('investor'));
            }

            // Calculator type toggle buttons
            const brokerToggle = document.getElementById('brokerToggle');
            const investorToggle = document.getElementById('investorToggle');
            
            if (brokerToggle) {
                brokerToggle.addEventListener('click', () => switchCalculator('broker'));
            }
            
            if (investorToggle) {
                investorToggle.addEventListener('click', () => switchCalculator('investor'));
            }

            // Auto-calculate on input changes for broker calculator
            const brokerInputIds = [
                'netCommission', 'commissionSplit', 'avgSalePrice', 'avgCommission',
                'closingRatio', 'appointmentRatio', 'contactRatio', 'attemptRatio',
                'vacationDays', 'sickDays', 'conferenceDays', 'trainingDays'
            ];
            
            brokerInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateNumbers);
                    element.addEventListener('change', calculateNumbers);
                }
            });

            // Auto-calculate on input changes for investor calculator
            const investorInputIds = [
                'netAcquisitionFee', 'reinvestmentPercentage', 'invAvgSalePrice', 'avgAcquisitionFee',
                'invClosingRatio', 'opportunityRatio', 'invAppointmentRatio', 'invContactRatio', 'invAttemptRatio',
                'invVacationDays', 'invSickDays', 'invConferenceDays', 'invTrainingDays'
            ];
            
            investorInputIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateInvestorNumbers);
                    element.addEventListener('change', calculateInvestorNumbers);
                }
            });

            console.log('Event listeners set up for calculator inputs and buttons');
        }

        // Logout handler
        async function handleLogout() {
            if (window.authManager) {
                await window.authManager.handleLogout();
            } else {
                // Fallback if auth manager not available
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Calculator Functions - EXACT logic from goal-tracker.txt
        function calculateNumbers() {
            console.log('calculateNumbers() called');
            
            var netCommission = parseFloat(document.getElementById('netCommission').value) || 0;
            var commissionSplit = (parseFloat(document.getElementById('commissionSplit').value) || 0) / 100;
            var avgSalePrice = parseFloat(document.getElementById('avgSalePrice').value) || 0;
            var avgCommission = (parseFloat(document.getElementById('avgCommission').value) || 0) / 100;
            var closingRatio = (parseFloat(document.getElementById('closingRatio').value) || 0) / 100;
            var appointmentRatio = (parseFloat(document.getElementById('appointmentRatio').value) || 0) / 100;
            var contactRatio = (parseFloat(document.getElementById('contactRatio').value) || 0) / 100;
            var attemptRatio = (parseFloat(document.getElementById('attemptRatio').value) || 0) / 100;
            var vacationDays = parseInt(document.getElementById('vacationDays').value) || 0;
            var sickDays = parseInt(document.getElementById('sickDays').value) || 0;
            var conferenceDays = parseInt(document.getElementById('conferenceDays').value) || 0;
            var trainingDays = parseInt(document.getElementById('trainingDays').value) || 0;

            console.log('Input values:', {
                netCommission, commissionSplit, avgSalePrice, avgCommission,
                closingRatio, appointmentRatio, contactRatio, attemptRatio,
                vacationDays, sickDays, conferenceDays, trainingDays
            });

            // EXACT calculations from goal-tracker.txt file
            var grossCommission = netCommission / commissionSplit;
            var totalWeeksNotProspecting = Math.ceil((vacationDays + sickDays + conferenceDays + trainingDays) / 5);
            var weeksWorked = 52 - totalWeeksNotProspecting;
            
            var closingsNeeded = grossCommission / (avgSalePrice * avgCommission);
            var contractsNeeded = closingsNeeded / closingRatio;
            var appointmentsNeeded = contractsNeeded / appointmentRatio;
            var decisionMakers = appointmentsNeeded / contactRatio;
            var totalAttempts = decisionMakers / attemptRatio;
            var dailyAttempts = totalAttempts / (weeksWorked * 5);

            // Store goals globally
            goals = {
                grossCommission: Math.ceil(grossCommission),
                weeksWorked: weeksWorked,
                closingsNeeded: Math.ceil(closingsNeeded),
                contractsNeeded: Math.ceil(contractsNeeded),
                appointmentsNeeded: Math.ceil(appointmentsNeeded),
                decisionMakers: Math.ceil(decisionMakers),
                totalAttempts: Math.ceil(totalAttempts),
                dailyAttempts: Math.ceil(dailyAttempts),
                netCommission: netCommission,
                commissionSplit: commissionSplit * 100,
                avgSalePrice: avgSalePrice,
                avgCommission: avgCommission * 100,
                closingRatio: closingRatio * 100,
                appointmentRatio: appointmentRatio * 100,
                contactRatio: contactRatio * 100,
                attemptRatio: attemptRatio * 100,
                vacationDays: vacationDays,
                sickDays: sickDays,
                conferenceDays: conferenceDays,
                trainingDays: trainingDays
            };

            console.log('Calculated goals:', goals);

            // Update display with EXACT formatting from goal-tracker.txt
            document.getElementById('grossCommission').textContent = '$' + goals.grossCommission.toLocaleString('en-US');
            document.getElementById('weeksWorked').textContent = goals.weeksWorked.toString();
            document.getElementById('closingsNeeded').textContent = goals.closingsNeeded.toString();
            document.getElementById('contractsNeeded').textContent = goals.contractsNeeded.toString();
            document.getElementById('appointmentsNeeded').textContent = goals.appointmentsNeeded.toString();
            document.getElementById('decisionMakers').textContent = goals.decisionMakers.toString();
            document.getElementById('totalAttempts').textContent = goals.totalAttempts.toLocaleString('en-US');
            document.getElementById('dailyAttempts').textContent = goals.dailyAttempts.toString();
            
            console.log('Display updated successfully');
        }

        // Investor Calculator Functions - EXACT logic from goal-invrstors.txt
        function calculateInvestorNumbers() {
            console.log('calculateInvestorNumbers() called');
            
            var netAcquisitionFee = parseFloat(document.getElementById('netAcquisitionFee').value) || 0;
            var reinvestmentPercentage = (parseFloat(document.getElementById('reinvestmentPercentage').value) || 0) / 100;
            var avgSalePrice = parseFloat(document.getElementById('invAvgSalePrice').value) || 0;
            var avgAcquisitionFee = (parseFloat(document.getElementById('avgAcquisitionFee').value) || 0) / 100;
            var closingRatio = (parseFloat(document.getElementById('invClosingRatio').value) || 0) / 100;
            var opportunityRatio = (parseFloat(document.getElementById('opportunityRatio').value) || 0) / 100;
            var appointmentRatio = (parseFloat(document.getElementById('invAppointmentRatio').value) || 0) / 100;
            var contactRatio = (parseFloat(document.getElementById('invContactRatio').value) || 0) / 100;
            var attemptRatio = (parseFloat(document.getElementById('invAttemptRatio').value) || 0) / 100;
            var vacationDays = parseInt(document.getElementById('invVacationDays').value) || 0;
            var sickDays = parseInt(document.getElementById('invSickDays').value) || 0;
            var conferenceDays = parseInt(document.getElementById('invConferenceDays').value) || 0;
            var trainingDays = parseInt(document.getElementById('invTrainingDays').value) || 0;

            console.log('Investor input values:', {
                netAcquisitionFee, reinvestmentPercentage, avgSalePrice, avgAcquisitionFee,
                closingRatio, opportunityRatio, appointmentRatio, contactRatio, attemptRatio,
                vacationDays, sickDays, conferenceDays, trainingDays
            });

            // EXACT calculations from goal-invrstors.txt file
            var grossAcquisitionFee = netAcquisitionFee / (1 - reinvestmentPercentage);
            var totalWeeksNotProspecting = Math.ceil((vacationDays + sickDays + conferenceDays + trainingDays) / 5);
            var weeksWorked = 52 - totalWeeksNotProspecting;
            
            var closingsNeeded = (grossAcquisitionFee / avgAcquisitionFee) / avgSalePrice;
            var contractsNeeded = closingsNeeded / closingRatio;
            var opportunitiesNeeded = contractsNeeded / opportunityRatio;
            var appointmentsNeeded = opportunitiesNeeded / appointmentRatio;
            var decisionMakers = appointmentsNeeded / contactRatio;
            var totalAttempts = decisionMakers / attemptRatio;
            var dailyAttempts = (totalAttempts / weeksWorked) / 5;

            // Store investor goals globally
            goals = {
                grossAcquisitionFee: Math.ceil(grossAcquisitionFee),
                weeksWorked: weeksWorked,
                closingsNeeded: Math.ceil(closingsNeeded),
                contractsNeeded: Math.ceil(contractsNeeded),
                opportunitiesNeeded: Math.ceil(opportunitiesNeeded),
                appointmentsNeeded: Math.ceil(appointmentsNeeded),
                decisionMakers: Math.ceil(decisionMakers),
                totalAttempts: Math.ceil(totalAttempts),
                dailyAttempts: Math.ceil(dailyAttempts),
                netAcquisitionFee: netAcquisitionFee,
                reinvestmentPercentage: reinvestmentPercentage * 100,
                avgSalePrice: avgSalePrice,
                avgAcquisitionFee: avgAcquisitionFee * 100,
                closingRatio: closingRatio * 100,
                opportunityRatio: opportunityRatio * 100,
                appointmentRatio: appointmentRatio * 100,
                contactRatio: contactRatio * 100,
                attemptRatio: attemptRatio * 100,
                vacationDays: vacationDays,
                sickDays: sickDays,
                conferenceDays: conferenceDays,
                trainingDays: trainingDays
            };

            console.log('Calculated investor goals:', goals);

            // Update display with EXACT formatting from goal-invrstors.txt
            document.getElementById('grossAcquisitionFee').textContent = '$' + goals.grossAcquisitionFee.toLocaleString('en-US');
            document.getElementById('invWeeksWorked').textContent = goals.weeksWorked.toString();
            document.getElementById('invClosingsNeeded').textContent = goals.closingsNeeded.toString();
            document.getElementById('invContractsNeeded').textContent = goals.contractsNeeded.toString();
            document.getElementById('opportunitiesNeeded').textContent = goals.opportunitiesNeeded.toString();
            document.getElementById('invAppointmentsNeeded').textContent = goals.appointmentsNeeded.toString();
            document.getElementById('invDecisionMakers').textContent = goals.decisionMakers.toString();
            document.getElementById('invTotalAttempts').textContent = goals.totalAttempts.toLocaleString('en-US');
            document.getElementById('invDailyAttempts').textContent = goals.dailyAttempts.toString();
            
            console.log('Investor display updated successfully');
        }

        // Save goals to database
        async function saveGoals(calculatorType = null) {
            if (!currentUser) {
                alert('Please log in to save your goals. You can still use the calculator without logging in!');
                return;
            }

            if (Object.keys(goals).length === 0) {
                alert('Please calculate your goals first');
                return;
            }

            // Determine which calculator type to save
            const userType = calculatorType || currentCalculatorType;

            try {
                const response = await window.authManager.makeAuthenticatedRequest('/api/goals/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userType: userType,
                        goalData: goals
                    })
                });

                if (response.ok) {
                    alert(`${userType.charAt(0).toUpperCase() + userType.slice(1)} goals saved successfully!`);
                } else {
                    const error = await response.json();
                    alert('Failed to save goals: ' + (error.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Save goals error:', error);
                alert('Failed to save goals. Please try again.');
            }
        }

        // Load saved goals
        async function loadSavedGoals() {
            if (!currentUser || !window.authManager) return;

            try {
                const response = await window.authManager.makeAuthenticatedRequest('/api/goals/load');

                if (response.ok) {
                    const result = await response.json();
                    if (result.goals && result.goals.goal_data) {
                        const savedGoals = result.goals.goal_data;
                        
                        // Restore form values
                        if (savedGoals.netCommission) {
                            document.getElementById('netCommission').value = savedGoals.netCommission;
                            document.getElementById('commissionSplit').value = savedGoals.commissionSplit;
                            document.getElementById('avgSalePrice').value = savedGoals.avgSalePrice;
                            document.getElementById('avgCommission').value = savedGoals.avgCommission;
                            document.getElementById('closingRatio').value = savedGoals.closingRatio;
                            document.getElementById('appointmentRatio').value = savedGoals.appointmentRatio;
                            document.getElementById('contactRatio').value = savedGoals.contactRatio;
                            document.getElementById('attemptRatio').value = savedGoals.attemptRatio;
                            document.getElementById('vacationDays').value = savedGoals.vacationDays;
                            document.getElementById('sickDays').value = savedGoals.sickDays;
                            document.getElementById('conferenceDays').value = savedGoals.conferenceDays;
                            document.getElementById('trainingDays').value = savedGoals.trainingDays;
                        }
                    }
                }

            } catch (error) {
                console.error('Load goals error:', error);
            }
        }

        // Calculator type switching
        function switchCalculator(type) {
            const brokerCalc = document.getElementById('brokerCalculator');
            const investorCalc = document.getElementById('investorCalculator');
            const toggleButtons = document.querySelectorAll('.toggle-btn');

            toggleButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            currentCalculatorType = type;

            if (type === 'broker') {
                brokerCalc.style.display = 'block';
                investorCalc.style.display = 'none';
                document.getElementById('brokerToggle').classList.add('active');
                // Calculate numbers on switch
                setTimeout(() => calculateNumbers(), 100);
            } else {
                brokerCalc.style.display = 'none';
                investorCalc.style.display = 'block';
                document.getElementById('investorToggle').classList.add('active');
                // Calculate investor numbers on switch
                setTimeout(() => calculateInvestorNumbers(), 100);
            }
            
            console.log('Switched to', type, 'calculator');
        }
    </script>

    <!-- Auth Management -->
    <script src="/js/auth.js"></script>
    
    <!-- Iframe Detection -->
    <script src="/js/iframe-detector.js"></script>
</body>
</html>